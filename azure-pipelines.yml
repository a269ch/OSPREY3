trigger:
- develop

jobs:
- job: Assemble
  pool:
    vmImage: 'ubuntu-20.04'

  steps:
  - checkout: self
    lfs: true
    displayName: "Init the repository with LFS"

  - task: Gradle@2
    inputs:
      gradleWrapperFile: 'gradlew'
      tasks: 'shadowDistTar'
      publishJUnitResults: false
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.11'
      gradleOptions: '-Xmx3096m'
      sonarQubeRunAnalysis: false

  - task: CopyFiles@2
    inputs:
      SourceFolder: 'build/distributions/'
      Contents: |
        *.tar
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
    displayName: Copy distributions to staging dir

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: Runnable app
      publishLocation: 'Container'
    displayName: Make staging dir an artifact

- job: CreateRelease
  pool:
    vmImage: ubuntu-latest
  dependsOn: Assemble
  condition: ne(variables['Build.Reason'], 'PullRequest')
  steps:
  - bash: |
      version=$(<src/main/resources/config/version)
      echo "##vso[task.setvariable variable=version]${version}"
    displayName: Set version variable from version file
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'specific'
      downloadPath: '$(System.ArtifactsDirectory)'
    displayName: Download assembled artifacts
  - task: GitHubRelease@1
    inputs:
      gitHubConnection: 'github.com_gusennan'
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'userSpecifiedTag'
      tag: '$(version).$(Build.BuildId)'
      assets: '$(System.ArtifactsDirectory)/**/*.tar'
      isDraft: false
      isPreRelease: true
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
      title: '$(version).$(Build.BuildId)'
    displayName: Push draft release $(version).$(Build.BuildId)